/**
 * Personalization Utilities - Phase 0
 * ê°œì¸í™”ëœ ë©”ì‹œì§€ ë° ê²½í—˜ ìƒì„±
 *
 * ì‹¬ë¦¬í•™ ì›ë¦¬: Self-Relevance Effect
 * - "ë‚˜ë¥¼ ì•Œì•„ì£¼ëŠ” ì•±" = ë” ë†’ì€ ì°¸ì—¬ë„
 * - ì´ë¦„ í˜¸ì¶œ, ì‹œê°„ëŒ€ ì¸ì‚¬, ë§ì¶¤ ë©”ì‹œì§€
 */

import { ActivityType } from '@/types/activity';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Types
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export interface UserContext {
  name: string;
  currentStreak: number;
  longestStreak: number;
  totalXP: number;
  lessonsToday: number;
  dailyGoal: number;
  weakestSkill?: ActivityType;
  strongestSkill?: ActivityType;
  lastStudyDate: string | null;
  totalDaysStudied: number;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì‹œê°„ëŒ€ë³„ ì¸ì‚¬ë§
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * ì‹œê°„ëŒ€ì— ë§ëŠ” ì¸ì‚¬ë§ ìƒì„±
 */
export function getGreeting(name: string): string {
  const hour = new Date().getHours();

  // ìƒˆë²½ (0-5ì‹œ)
  if (hour < 6) {
    return `ë°¤ëŠ¦ê²Œê¹Œì§€ ì—´ê³µì´ë„¤ìš”, ${name}ë‹˜! ğŸŒ™`;
  }
  // ì•„ì¹¨ (6-11ì‹œ)
  if (hour < 12) {
    return `ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”, ${name}ë‹˜! â˜€ï¸`;
  }
  // ì ì‹¬ (12-13ì‹œ)
  if (hour < 14) {
    return `ì ì‹¬ ë§›ìˆê²Œ ë“œì…¨ë‚˜ìš”, ${name}ë‹˜? ğŸ½ï¸`;
  }
  // ì˜¤í›„ (14-17ì‹œ)
  if (hour < 18) {
    return `ì¢‹ì€ ì˜¤í›„ì˜ˆìš”, ${name}ë‹˜! ğŸŒ¤ï¸`;
  }
  // ì €ë… (18-20ì‹œ)
  if (hour < 21) {
    return `ì¢‹ì€ ì €ë…ì´ì—ìš”, ${name}ë‹˜! ğŸŒ†`;
  }
  // ë°¤ (21-23ì‹œ)
  return `ì˜¤ëŠ˜ í•˜ë£¨ë„ ê³ ìƒí–ˆì–´ìš”, ${name}ë‹˜! ğŸŒ™`;
}

/**
 * ì‹œê°„ëŒ€ë³„ ê°„ë‹¨í•œ ì¸ì‚¬ (ì´ë¦„ ì—†ì´)
 */
export function getSimpleGreeting(): string {
  const hour = new Date().getHours();

  if (hour < 6) return 'ë°¤ëŠ¦ê²Œê¹Œì§€ ì—´ê³µ! ğŸŒ™';
  if (hour < 12) return 'ì¢‹ì€ ì•„ì¹¨! â˜€ï¸';
  if (hour < 14) return 'ì ì‹¬ ì‹œê°„ì´ì—ìš” ğŸ½ï¸';
  if (hour < 18) return 'ì¢‹ì€ ì˜¤í›„! ğŸŒ¤ï¸';
  if (hour < 21) return 'ì¢‹ì€ ì €ë…! ğŸŒ†';
  return 'ì¢‹ì€ ë°¤! ğŸŒ™';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€
 */
export function getMotivationalMessage(context: UserContext): string {
  const { name, currentStreak, lessonsToday, dailyGoal, weakestSkill, totalXP } = context;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìš°ì„ ìˆœìœ„ 1: ìŠ¤íŠ¸ë¦­ ê´€ë ¨
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (currentStreak >= 100) {
    return `ğŸ† ${currentStreak}ì¼ ì—°ì†! ${name}ë‹˜ì€ ì§„ì •í•œ ë ˆì „ë“œì˜ˆìš”!`;
  }
  if (currentStreak >= 30) {
    return `ğŸ”¥ í•œ ë‹¬ ì—°ì† í•™ìŠµ! ${name}ë‹˜ì˜ ëˆê¸°ê°€ ëŒ€ë‹¨í•´ìš”!`;
  }
  if (currentStreak >= 7) {
    return `ğŸ”¥ ${currentStreak}ì¼ì§¸ ë¶ˆíƒ€ê³  ìˆì–´ìš”! ì´ í˜ì´ìŠ¤ ìœ ì§€í•´ìš”!`;
  }
  if (currentStreak >= 3) {
    return `ğŸ”¥ ${currentStreak}ì¼ ì—°ì† í•™ìŠµ ì¤‘! ê³„ì† ê°€ë³´ì!`;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìš°ì„ ìˆœìœ„ 2: ì¼ì¼ ëª©í‘œ ê´€ë ¨
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (lessonsToday >= dailyGoal) {
    return `ğŸ¯ ì˜¤ëŠ˜ ëª©í‘œ ë‹¬ì„±! ì¶”ê°€ í•™ìŠµí•˜ë©´ ë³´ë„ˆìŠ¤ XP!`;
  }

  const remaining = dailyGoal - lessonsToday;

  if (remaining === 1) {
    return `ğŸ¯ ë”± 1ê°œë§Œ ë”! ì˜¤ëŠ˜ ëª©í‘œ ë‹¬ì„± ì½”ì•ì´ì—ìš”!`;
  }
  if (remaining <= 3) {
    return `ğŸ¯ ${remaining}ê°œë§Œ ë”! ì˜¤ëŠ˜ ëª©í‘œ ë‹¬ì„± ê°€ëŠ¥í•´ìš”!`;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìš°ì„ ìˆœìœ„ 3: ì•½ì  ìŠ¤í‚¬ ê´€ë ¨
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (weakestSkill) {
    const skillNames: Record<ActivityType, string> = {
      vocabulary: 'ì–´íœ˜',
      grammar: 'ë¬¸ë²•',
      listening: 'ë“£ê¸°',
      reading: 'ì½ê¸°',
      speaking: 'ë§í•˜ê¸°',
      writing: 'ì“°ê¸°',
    };
    return `ğŸ’ª ${skillNames[weakestSkill]} ì‹¤ë ¥ì„ ì˜¬ë ¤ë³¼ê¹Œìš”?`;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìš°ì„ ìˆœìœ„ 4: XP ë§ˆì¼ìŠ¤í†¤
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (totalXP > 0) {
    const nextMilestone = getNextXPMilestone(totalXP);
    const remaining = nextMilestone - totalXP;
    if (remaining <= 50) {
      return `âœ¨ ${remaining} XPë§Œ ë” ëª¨ìœ¼ë©´ ${nextMilestone} XP ë‹¬ì„±!`;
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê¸°ë³¸ ë©”ì‹œì§€ (ëœë¤)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return getRandomMotivation();
}

/**
 * ëœë¤ ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€
 */
function getRandomMotivation(): string {
  const messages = [
    'ì˜¤ëŠ˜ë„ ì˜ì–´ ì‹¤ë ¥ì´ ì‘¥ì‘¥! ğŸ“ˆ',
    'ê¾¸ì¤€í•¨ì´ ì‹¤ë ¥ì´ì—ìš”! ğŸ’ª',
    'ì˜¤ëŠ˜ ë°°ìš´ ê±´ ë‚´ì¼ì˜ ìì‚°! ğŸŒ±',
    'í•œ ê±¸ìŒì”© ë‚˜ì•„ê°€ê³  ìˆì–´ìš”! ğŸš¶',
    'ì¡°ê¸ˆì”©, í•˜ì§€ë§Œ í™•ì‹¤í•˜ê²Œ! âœ¨',
    'ì˜ì–´, ì¬ë¯¸ìˆê²Œ ë°°ì›Œìš”! ğŸ‰',
    'ì§€ê¸ˆ ì´ ìˆœê°„ì´ ì„±ì¥ì˜ ì‹œê°„! ğŸŒŸ',
    'í¬ê¸°í•˜ì§€ ì•Šìœ¼ë©´ ì„±ê³µí•´ìš”! ğŸ†',
  ];

  return messages[Math.floor(Math.random() * messages.length)];
}

/**
 * ë‹¤ìŒ XP ë§ˆì¼ìŠ¤í†¤ ê³„ì‚°
 */
function getNextXPMilestone(currentXP: number): number {
  const milestones = [100, 250, 500, 1000, 2500, 5000, 10000, 25000, 50000, 100000];

  for (const milestone of milestones) {
    if (milestone > currentXP) {
      return milestone;
    }
  }

  return milestones[milestones.length - 1];
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì¶•í•˜ ë©”ì‹œì§€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export type MilestoneType =
  | 'streak_3'
  | 'streak_7'
  | 'streak_14'
  | 'streak_30'
  | 'streak_100'
  | 'level_up'
  | 'badge_earned'
  | 'xp_100'
  | 'xp_500'
  | 'xp_1000'
  | 'xp_5000'
  | 'xp_10000'
  | 'perfect_score'
  | 'all_skills_today';

/**
 * ë§ˆì¼ìŠ¤í†¤ ë‹¬ì„± ì¶•í•˜ ë©”ì‹œì§€
 */
export function getCelebrationMessage(milestone: MilestoneType, name?: string): string {
  const messages: Record<MilestoneType, string> = {
    streak_3: 'ğŸ”¥ 3ì¼ ì—°ì† í•™ìŠµ ì‹œì‘!',
    streak_7: 'ğŸ‰ ì¼ì£¼ì¼ ì—°ì† í•™ìŠµ ë‹¬ì„±!',
    streak_14: 'ğŸ… 2ì£¼ ì—°ì†! ì •ë§ ëŒ€ë‹¨í•´ìš”!',
    streak_30: 'ğŸ† í•œ ë‹¬ ì—°ì† í•™ìŠµ! ë‹¹ì‹ ì€ ì§„ì •í•œ í•™ìŠµì!',
    streak_100: 'ğŸ‘‘ 100ì¼ ìŠ¤íŠ¸ë¦­! ë ˆì „ë“œì…ë‹ˆë‹¤!',
    level_up: 'â¬†ï¸ ë ˆë²¨ ì—…! ì‹¤ë ¥ì´ ì„±ì¥í•˜ê³  ìˆì–´ìš”!',
    badge_earned: 'ğŸ… ìƒˆë¡œìš´ ë°°ì§€ë¥¼ íšë“í–ˆì–´ìš”!',
    xp_100: 'âœ¨ 100 XP ë‹¬ì„±!',
    xp_500: 'âœ¨ 500 XP ë‹¬ì„±!',
    xp_1000: 'ğŸ’« 1,000 XP ë‹¬ì„±!',
    xp_5000: 'â­ 5,000 XP ë‹¬ì„±!',
    xp_10000: 'ğŸ’ 10,000 XP ë‹¬ì„±! ëŒ€ë‹¨í•´ìš”!',
    perfect_score: 'ğŸ’¯ í¼í™íŠ¸! ë§Œì ì´ì—ìš”!',
    all_skills_today: 'ğŸŒŸ ì˜¤ëŠ˜ ëª¨ë“  ìŠ¤í‚¬ í•™ìŠµ ì™„ë£Œ!',
  };

  let message = messages[milestone] || 'ğŸ‰ ì¶•í•˜í•´ìš”!';

  if (name) {
    message = message.replace('!', `, ${name}ë‹˜!`);
  }

  return message;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë³µê·€ ë©”ì‹œì§€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * ë³µê·€ ì‚¬ìš©ì ë©”ì‹œì§€
 */
export function getReturnMessage(daysSinceLastStudy: number, name: string): string {
  if (daysSinceLastStudy <= 0) {
    return `ì˜¤ëŠ˜ë„ ì™”ë„¤ìš”, ${name}ë‹˜! ğŸ¤—`;
  }
  if (daysSinceLastStudy === 1) {
    return `ì–´ì œ ì‰¬ì—ˆêµ°ìš”! ë‹¤ì‹œ ì‹œì‘í•´ìš”, ${name}ë‹˜! ğŸ’ª`;
  }
  if (daysSinceLastStudy <= 3) {
    return `${daysSinceLastStudy}ì¼ë§Œì— ëŒì•„ì™”ë„¤ìš”! ë°˜ê°€ì›Œìš”, ${name}ë‹˜! ğŸ˜Š`;
  }
  if (daysSinceLastStudy <= 7) {
    return `ì¼ì£¼ì¼ ê°€ê¹Œì´ ì‰¬ì—ˆêµ°ìš”! ë‹¤ì‹œ í™”ì´íŒ…, ${name}ë‹˜! ğŸ”¥`;
  }
  if (daysSinceLastStudy <= 30) {
    return `ì˜¤ëœë§Œì´ì—ìš”, ${name}ë‹˜! ë‹¤ì‹œ ì‹œì‘í•˜ë©´ ë¼ìš”! ğŸŒ±`;
  }
  return `${name}ë‹˜, ëŒì•„ì˜¤ì…¨êµ°ìš”! ìƒˆë¡œìš´ ì‹œì‘ì„ í•´ë´ìš”! ğŸš€`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì¼ì¼ ëª©í‘œ ê´€ë ¨
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * ëª©í‘œ ë‹¬ì„±ë¥ ì— ë”°ë¥¸ ë©”ì‹œì§€
 */
export function getDailyProgressMessage(lessonsToday: number, dailyGoal: number): string {
  const progress = lessonsToday / dailyGoal;

  if (progress >= 2) {
    return 'ğŸš€ ì˜¤ë²„ ë‹¬ì„±! ëŒ€ë‹¨í•´ìš”!';
  }
  if (progress >= 1) {
    return 'ğŸ¯ ëª©í‘œ ë‹¬ì„±!';
  }
  if (progress >= 0.75) {
    return 'ğŸ’ª ê±°ì˜ ë‹¤ ì™”ì–´ìš”!';
  }
  if (progress >= 0.5) {
    return 'ğŸ“ˆ ì ˆë°˜ ë‹¬ì„±!';
  }
  if (progress > 0) {
    return 'ğŸŒ± ì¢‹ì€ ì‹œì‘!';
  }
  return 'ğŸ¯ ì˜¤ëŠ˜ì˜ ëª©í‘œë¥¼ ì‹œì‘í•´ìš”!';
}
